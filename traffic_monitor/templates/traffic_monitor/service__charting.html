{% extends 'traffic_monitor/section_wrapper.html' %}

{% block title %}Detection Trend{% endblock title %}

{% block content %}
    {% csrf_token %}

    <script type="text/javascript">

        function setup_chartsocket(monitor_name) {
            {# A socket is created that will be used to capture messages from #}
            {# the backend. When updates are received the web page is updated #}
            {# with the respective log information. #}

            const chartSocket = new WebSocket('ws://' + window.location.host + '/ws/traffic_monitor/chart/' + monitor_name + '/')
            {# Setup Chart #}
            let url = 'get_chart?monitor_name=' + monitor_name;
            let target_div = document.getElementById('plot-area')

            {# Update Chart #}
            chartSocket.onmessage = function(e) {
                {# Draw a new chart when a message is received by socket #}
                console.log("updating chart ...")

                {# Update the menu in case new logged items are available #}
                setup_charting_dropdown_menu('{{ monitor_name }}');

                const item = JSON.parse(e.data)
                target_div.innerHTML = ''
                target_div.setAttribute('data-url', url);
                if (item['success'] === false) {
                    target_div.innerHTML = "<div class='align-middle'" + item['message'] + "</div>";
                } else {
                    Bokeh.embed.embed_item(item, 'plot-area');
                }
            }

            chartSocket.onclose = function(e) {
                console.log("chartSocket closed!")
            }

            chartSocket.onopen = function(e) {
                console.log("chartSocket opened!")
            }

        }

        function force_chart_update(monitor_name) {
            {# Used to present a chart to the user when page is loaded without starting monitor #}
            let url = 'get_chart?monitor_name=' + monitor_name;
            let target_div = document.getElementById('plot-area')
            fetch(url)
                .then(data => {return data.json()})
                .then(item => {
                    target_div.innerHTML = '';
                    target_div.setAttribute('data-url', url);
                    if (item['success'] === false) {
                    target_div.innerHTML = "<div class='align-middle'" + item['message'] + "</div>";
                } else {
                    Bokeh.embed.embed_item(item, 'plot-area');
                }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }


        function embed_chart(monitor_name) {
            {# set chart to 30 hours ago #}
            var d = new Date();
            d.setHours(d.getHours() - 30);
            var limit_start_days = 8
            let url = 'http://127.0.0.1:8100/monitor_chart?monitor_name=' + monitor_name + '&start_date=' + d.toISOString() + '&limit_start_days=' + limit_start_days;
            let target_div = document.getElementById('plot-area')
            target_div.setAttribute('src', url)
        }

        let chart_script;
        async function get_chart_embedding_script(monitor_name) {
            let url = 'get_chart_embedded?monitor_name=' + monitor_name;
            let target_div = document.getElementById('plot-area')
            await fetch(url)
                .then(data => {
                    console.log(data.json());
                    chart_script = data;
                })
                .catch((error) => {
                    console.error('Error:', error);
                })
        }


        async function get_chart_embedding(monitor_name) {
            let url = 'get_chart_embedded?monitor_name=' + monitor_name;
            let target_div = document.getElementById('plot-area')
            await fetch(url)
                .then(data => {return data.json()})
                .then(script => {
                    console.log(script);
                    target_div.innerHTML = script;
                    })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function set_chart_time_horizon(monitor_name, horizon) {
            const url ='set_chart_time_horizon?monitor_name=' + monitor_name + '&value=' + horizon;
            fetch(url).then(() => force_chart_update(monitor_name));
        }

        function set_chart_time_zone(monitor_name, zone) {
            const url ='set_chart_time_zone?monitor_name=' + monitor_name + '&value=' + zone;
            fetch(url).then(() => force_chart_update(monitor_name));
        }

        function toggle_chart_object(monitor_name, obj) {
            const url = 'toggle_chart_objects?monitor_name=' + monitor_name + '&objects=' + obj;
            fetch(url)
                .then(() => force_chart_update(monitor_name))
                .then(() => setup_charting_dropdown_menu(monitor_name));
        }

        async function setup_charting_dropdown_menu(monitor_name) {
            {# Update the parent's 'dropdown-menu' tag with <a> links #}
            let menulisting = document.getElementById('{{ section_id }}').getElementsByClassName('dropdown-menu')[0]
            menulisting.innerText = '';

            let menu_header1 = document.createElement('p');
            menu_header1.className = "dropdown-header";
            menu_header1.innerText = "Time Horizon:";
            menulisting.appendChild(menu_header1);

            let horizons = [{'desc':'1 Hour', 'value':'1'}, {'desc':'6 Hours', 'value':'6'} , {'desc':'12 Hours', 'value':'12'}, {'desc':'1 Day', 'value':'day'}, {'desc':'1 Week', 'value':'week'}, {'desc':'1 Month', 'value':'month'}]
            for (let t in horizons) {
                let elem = document.createElement('a');
                elem.className = "dropdown-item py-0";
                elem.setAttribute('role', "presentation");
                elem.href = '#';
                elem.onclick = () => {
                    set_chart_time_horizon(monitor_name, horizons[t]['value'])
                };
                elem.innerText = horizons[t]['desc'];
                menulisting.appendChild(elem);
            }

            let div = document.createElement('div');
            div.className = "dropdown-divider";
            menulisting.appendChild(div);

            let menu_header2 = document.createElement('p');
            menu_header2.className = "dropdown-header";
            menu_header2.innerText = "Time Zone:";
            menulisting.appendChild(menu_header2);

            let time_zone = await get_monitor_config_value(monitor_name, 'time_zone');
            let zones = [{'desc':'UTC', 'value':'UTC'}, {'desc':'US/Eastern', 'value':'US/Eastern'}, {'desc':time_zone + ' (source)', 'value': time_zone}]
            for (let z in zones) {
                if (zones.hasOwnProperty(z)) {
                    let elem = document.createElement('a');
                    elem.className = "dropdown-item py-0";
                    elem.setAttribute('role', "presentation");
                    elem.href = '#';
                    elem.onclick = () => {
                        set_chart_time_zone(monitor_name, zones[z]['value'])
                    };
                    elem.innerText = zones[z]['desc'];
                    menulisting.appendChild(elem);
                }
            }

            menulisting.appendChild(div)
            let menu_header3 = document.createElement('p');
            menu_header3.className = "dropdown-header";
            menu_header3.innerText = "Display:";
            menulisting.appendChild(menu_header3);

            let url = 'get_all_log_objects?monitor_name=' + monitor_name;
            let all_logged_objects = await fetch(url).then(data => {
                                                                        return data.json();
                                                                   })
            let chart_objects = await get_monitor_config_value(monitor_name, 'charting_objects');

            for (let lo in all_logged_objects) {
                if (all_logged_objects.hasOwnProperty(lo)) {
                    let elem = document.createElement('a');
                    elem.className = "dropdown-item py-0";
                    elem.setAttribute('role', "presentation");
                    elem.href = '#';
                    elem.onclick = () => {
                        toggle_chart_object(monitor_name, all_logged_objects[lo])
                    };
                    elem.innerHTML = "<i class='far " + (chart_objects.includes(all_logged_objects[lo]) ? 'fa-check-square' : 'fa-square') + " '></i><span>&nbsp</span><span>" + all_logged_objects[lo] + "</span>";
                    menulisting.appendChild(elem);
                }
            }


        }

        {#On load, setup the channel to get communications from the server #}
        document.addEventListener('DOMContentLoaded', () => {
            {#Update the table of elements to monitor and log#}
            {#setup_chartsocket('{{ monitor_name }}');#}
            setup_charting_dropdown_menu('{{ monitor_name }}');
            {#force_chart_update('{{ monitor_name }}');#}
            embed_chart('{{ monitor_name }}');
        })

    </script>

    <div class="card-body p-1" style="height: 360px;">
{#        <div id="plot-area" data-label="Traffic Trends" style="height: 360px;">#}
{##}
{#        </div>#}

        <iframe class= "ml-1" id="plot-area" src="" width="100%" height="100%" style="border:none;"></iframe>
    </div>

{% endblock content %}



